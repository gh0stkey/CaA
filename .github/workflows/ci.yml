name: CI

on:
  push:
    # å¯¹æ‰€æœ‰åˆ†æ”¯è¿›è¡Œ CI æ£€æŸ¥
    branches: ['**']
  pull_request:
    branches: [master]

jobs:
  # ==========================================
  # Quick Check (æžé€Ÿåé¦ˆ) - æ‰€æœ‰åˆ†æ”¯çš„æ¯æ¬¡ push éƒ½è¿è¡Œ
  # åŒ…å«: Java ç¼–è¯‘æ£€æŸ¥
  # ==========================================
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Compile check
        run: ./gradlew compileJava

  # ==========================================
  # Build Test (æž„å»ºéªŒè¯) - ä»… PR åˆ° master æ—¶è¿è¡Œ
  # åŒ…å«: å®Œæ•´ Fat JAR æž„å»º
  # ==========================================
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: quick-check
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # å®Œæ•´æž„å»ºéªŒè¯
      - name: Build Fat JAR
        run: ./gradlew clean jar

      - name: Verify JAR artifact
        run: |
          JAR_FILE="build/libs/CaA.jar"
          if [ ! -f "$JAR_FILE" ]; then
            echo "::error::JAR file not found: $JAR_FILE"
            exit 1
          fi
          JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
          echo "## ðŸ“¦ Build Artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`CaA.jar\` | $JAR_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… JAR built successfully: $JAR_FILE ($JAR_SIZE)"

  # ==========================================
  # Dependency Check (ä¾èµ–æ£€æŸ¥) - ä»… PR åˆ° master æ—¶è¿è¡Œ
  # éžé˜»å¡žï¼šä»…ä½œä¸ºå‚è€ƒä¿¡æ¯ï¼Œä¸é˜»æ­¢åˆå¹¶
  # ==========================================
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Check dependency resolution
        run: |
          echo "## ðŸ“‹ Dependency Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ./gradlew dependencies --configuration runtimeClasspath 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
