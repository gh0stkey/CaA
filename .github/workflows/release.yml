name: Release

on:
  # Tag-based release
  push:
    tags:
      - 'v*.*.*'

  # Manual release trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================================
  # Pre-release Validation
  # ============================================================
  validate:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.is-prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Release version: $VERSION"

      - name: Check if pre-release
        id: check-prerelease
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          elif [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Pre-release: $IS_PRERELEASE"

      - name: Validate version format
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z or vX.Y.Z-suffix"
            exit 1
          fi
          echo "âœ… Version format valid"

      - name: Check version not already released
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if gh release view "$VERSION" &>/dev/null; then
            echo "::error::Release $VERSION already exists"
            exit 1
          fi
          echo "âœ… Version is new"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run compile check
        run: ./gradlew compileJava

  # ============================================================
  # Build Release JAR
  # ============================================================
  build:
    name: Build Release JAR
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build Fat JAR
        run: ./gradlew clean jar

      - name: Prepare release artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release

          cp build/libs/CaA.jar release/CaA_${VERSION}.jar

          echo "ğŸ“¦ Release artifacts prepared:"
          ls -lh release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          echo "## ğŸ” Checksums" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat checksums.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ needs.validate.outputs.version }}
          path: release/*
          retention-days: 30

  # ============================================================
  # Create GitHub Release
  # ============================================================
  create-release:
    name: Create GitHub Release
    needs: [validate, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.validate.outputs.version }}
          path: release/

      - name: Generate release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          # å»æ‰ v å‰ç¼€ç”¨äºæ ‡é¢˜æ˜¾ç¤º
          DISPLAY_VERSION="${VERSION#v}"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # æŒ‰ç…§é¡¹ç›®æ—¢æœ‰é£æ ¼ç”Ÿæˆ release notes
          echo "## æ›´æ–°å†…å®¹" > release_notes.md
          echo "" >> release_notes.md
          echo "CaA ${DISPLAY_VERSION}æ›´æ–°å†…å®¹å¦‚ä¸‹ã€‚" >> release_notes.md
          echo "" >> release_notes.md

          if [ -n "$PREV_TAG" ]; then
            # æŒ‰ commit message è‡ªåŠ¨åˆ†ç±»
            FEATURES=""
            FIXES=""
            OTHERS=""

            while IFS= read -r line; do
              if echo "$line" | grep -qiE "^(feat|add|æ–°å¢|åŠŸèƒ½|ä¼˜åŒ–|update|enhance|improve|refactor)"; then
                FEATURES="${FEATURES}\n- ${line}"
              elif echo "$line" | grep -qiE "^(fix|ä¿®å¤|bugfix|hotfix|patch)"; then
                FIXES="${FIXES}\n- ${line}"
              else
                OTHERS="${OTHERS}\n- ${line}"
              fi
            done < <(git log --pretty=format:"%s" $PREV_TAG..HEAD)

            echo "### åŠŸèƒ½æ›´æ–°" >> release_notes.md
            echo "" >> release_notes.md
            if [ -n "$FEATURES" ]; then
              echo -e "$FEATURES" >> release_notes.md
            else
              echo "æ— ã€‚" >> release_notes.md
            fi
            echo "" >> release_notes.md

            echo "### é—®é¢˜ä¿®å¤" >> release_notes.md
            echo "" >> release_notes.md
            if [ -n "$FIXES" ]; then
              echo -e "$FIXES" >> release_notes.md
            else
              echo "æ— ã€‚" >> release_notes.md
            fi

            if [ -n "$OTHERS" ]; then
              echo "" >> release_notes.md
              echo "### å…¶ä»–å˜æ›´" >> release_notes.md
              echo "" >> release_notes.md
              echo -e "$OTHERS" >> release_notes.md
            fi
          else
            echo "### åŠŸèƒ½æ›´æ–°" >> release_notes.md
            echo "" >> release_notes.md
            echo "é¦–æ¬¡å‘å¸ƒã€‚" >> release_notes.md
          fi

          echo ""
          echo "Release notes generated:"
          cat release_notes.md

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate.outputs.is-prerelease }}"

          PRERELEASE_FLAG=""
          if [ "$IS_PRERELEASE" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          DISPLAY_VERSION="${VERSION#v}"

          gh release create "$VERSION" \
            --title "$DISPLAY_VERSION" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG \
            release/*

      - name: Release summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "## ğŸš€ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ needs.validate.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
